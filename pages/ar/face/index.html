<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Face Emoji Overlay (Minimum)</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; background: #000; overflow: hidden; }
    #wrap { position: relative; width: 100%; height: 100%; }

    /* ã‚«ãƒ¡ãƒ©æ˜ åƒ */
    video {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* è‡ªæ’®ã‚Šé¡åƒ */
    }

    /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æç”»ç”¨ */
    canvas {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      transform: scaleX(-1); /* videoã¨åˆã‚ã›ã‚‹ */
    }

    /* ç°¡æ˜“UI */
    .hud {
      position: absolute; left: 12px; top: 12px;
      color: #fff; font: 14px/1.4 system-ui, -apple-system, sans-serif;
      background: rgba(0,0,0,.45); padding: 10px 12px; border-radius: 10px;
      max-width: calc(100% - 24px);
    }
    .hud button {
      margin-top: 8px; padding: 8px 10px; border-radius: 10px;
      border: 0; background: #fff; color: #000; font-weight: 600;
    }
    .hint { opacity: .85; font-size: 12px; margin-top: 6px; }
  </style>
</head>

<body>
  <div id="wrap">
    <video id="video" playsinline muted></video>
    <canvas id="overlay"></canvas>

    <div class="hud">
      <div id="status">loading...</div>
      <button id="switchBtn" type="button">ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
      <div class="hint">
        ã†ã¾ãã„ã‹ãªã„æ™‚ï¼šChromeã§é–‹ã / HTTPS / ã‚«ãƒ¡ãƒ©è¨±å¯ / æ˜ã‚‹ã„å ´æ‰€<br>
        â€»çµµæ–‡å­—ã¯ã€Œé¡”ã®ä¸­å¿ƒã€ã«è¿½å¾“ï¼ˆæœ€å°ç‰ˆï¼‰
      </div>
    </div>
  </div>

  <!-- MediaPipeï¼ˆCDNï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("overlay");
    const ctx = canvas.getContext("2d");
    const statusEl = document.getElementById("status");
    const switchBtn = document.getElementById("switchBtn");

    // é€éPNGã®çµµæ–‡å­—ï¼ˆTwemojiã®ç”»åƒï¼‰
    const emojiImg = new Image();
    emojiImg.crossOrigin = "anonymous";
    emojiImg.src = "https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f600.png"; // ğŸ˜€
    // ã“ã“ã‚’åˆ¥ã®çµµæ–‡å­—ã«å¤‰ãˆãŸã„å ´åˆã¯å¾Œã§æ¡ˆå†…ã—ã¾ã™

    // ç”»é¢ãƒªã‚µã‚¤ã‚ºã«è¿½å¾“
    function fitCanvas() {
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(canvas.clientWidth * dpr);
      canvas.height = Math.floor(canvas.clientHeight * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // CSSãƒ”ã‚¯ã‚»ãƒ«åŸºæº–ã§æã
    }
    window.addEventListener("resize", fitCanvas);

    // ãƒ•ãƒ­ãƒ³ãƒˆ/ãƒªã‚¢åˆ‡æ›¿
    let facingMode = "user"; // user = è‡ªæ’®ã‚Š, environment = èƒŒé¢
    let camera = null;

    async function start() {
      statusEl.textContent = "åˆæœŸåŒ–ä¸­â€¦ï¼ˆã‚«ãƒ¡ãƒ©è¨±å¯ã—ã¦ãã ã•ã„ï¼‰";

      fitCanvas();

      const faceDetection = new FaceDetection.FaceDetection({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`
      });

      faceDetection.setOptions({
        model: "short",            // è»½ã‚ï¼ˆã‚¹ãƒãƒ›å‘ã‘ï¼‰
        minDetectionConfidence: 0.6
      });

      faceDetection.onResults((results) => {
        // ç”»é¢ã‚¯ãƒªã‚¢
        ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);

        if (!results.detections || results.detections.length === 0) {
          statusEl.textContent = "é¡”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ˜ã‚‹ã„å ´æ‰€ã§æ­£é¢ã‚’å‘ã„ã¦ã­ï¼‰";
          return;
        }

        statusEl.textContent = `é¡”æ¤œçŸ¥: ${results.detections.length}äºº`;

        // ä¸€ç•ªæ‰‹å‰ã£ã½ã„1äººç›®ã ã‘ä½¿ã†ï¼ˆæœ€å°ï¼‰
        const det = results.detections[0];
        const box = det.boundingBox; // {xCenter, yCenter, width, height}ï¼ˆ0..1ï¼‰
        if (!box) return;

        // æ­£è¦åŒ–åº§æ¨™ â†’ ç”»é¢åº§æ¨™ï¼ˆCSSãƒ”ã‚¯ã‚»ãƒ«ï¼‰
        const x = box.xCenter * canvas.clientWidth;
        const y = box.yCenter * canvas.clientHeight;

        // é¡”ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦çµµæ–‡å­—ã‚µã‚¤ã‚ºã‚’æ±ºã‚ã‚‹
        const faceW = box.width * canvas.clientWidth;
        const size = Math.max(64, faceW * 0.9); // æœ€å°64px

        // çµµæ–‡å­—ã‚’é¡”ã®ä¸­å¿ƒã«æç”»
        const half = size / 2;
        ctx.drawImage(emojiImg, x - half, y - half, size, size);
      });

      // MediaPipeã®ã‚«ãƒ¡ãƒ©ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã§æ¯ãƒ•ãƒ¬ãƒ¼ãƒ é€ã‚‹
      async function startCamera() {
        if (camera) camera.stop();

        camera = new Camera(video, {
          onFrame: async () => {
            await faceDetection.send({ image: video });
          },
          width: 1280,
          height: 720,
          facingMode
        });

        await camera.start();
        statusEl.textContent = "èµ·å‹•ã—ã¾ã—ãŸã€‚é¡”ã‚’æ˜ ã—ã¦ã¿ã¦ãã ã•ã„ã€‚";
      }

      switchBtn.addEventListener("click", async () => {
        facingMode = (facingMode === "user") ? "environment" : "user";
        statusEl.textContent = "ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ä¸­â€¦";
        await startCamera();
      });

      await startCamera();
    }

    // ì‹œì‘
    start().catch((e) => {
      console.error(e);
      statusEl.textContent = "èµ·å‹•å¤±æ•—ï¼šã‚«ãƒ¡ãƒ©è¨±å¯ / HTTPS / ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆChromeæ¨å¥¨ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„";
    });
  </script>
</body>
</html>
