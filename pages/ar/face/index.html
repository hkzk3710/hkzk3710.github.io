<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Face Emoji Overlay (Minimum)</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; }
    #wrap { position:relative; width:100%; height:100%; }
    video, canvas { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
    video { transform: scaleX(-1); }
    canvas { pointer-events:none; transform: scaleX(-1); }

    .hud {
      position:absolute; left:12px; top:12px;
      color:#fff; font:14px/1.4 system-ui, -apple-system, sans-serif;
      background: rgba(0,0,0,.45); padding:10px 12px; border-radius:10px;
      max-width: calc(100% - 24px);
    }
    .hud button {
      margin-top:8px; padding:8px 10px; border-radius:10px;
      border:0; background:#fff; color:#000; font-weight:600;
    }
    .hint { opacity:.85; font-size:12px; margin-top:6px; }
  </style>
</head>

<body>
  <div id="wrap">
    <video id="video" playsinline muted></video>
    <canvas id="overlay"></canvas>

    <div class="hud">
      <div id="status">loading...</div>
      <button id="switchBtn" type="button">ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
      <div class="hint">
        ã†ã¾ãã„ã‹ãªã„æ™‚ï¼šChromeã§é–‹ã / HTTPS / ã‚«ãƒ¡ãƒ©è¨±å¯ / æ˜ã‚‹ã„å ´æ‰€<br>
        â€»çµµæ–‡å­—ã¯ã€Œé¡”ã®ä¸­å¿ƒã€ã«è¿½å¾“ï¼ˆæœ€å°ç‰ˆï¼‰
      </div>
    </div>
  </div>

  <!-- MediaPipeï¼ˆCDNï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("overlay");
    const ctx = canvas.getContext("2d");
    const statusEl = document.getElementById("status");
    const switchBtn = document.getElementById("switchBtn");

    const emojiImg = new Image();
    emojiImg.crossOrigin = "anonymous";
    emojiImg.src = "https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f600.png"; // ğŸ˜€

    function fitCanvas() {
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(canvas.clientWidth * dpr);
      canvas.height = Math.floor(canvas.clientHeight * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener("resize", fitCanvas);

    let facingMode = "user";
    let camera = null;

    async function main() {
      fitCanvas();
      statusEl.textContent = "åˆæœŸåŒ–ä¸­â€¦ï¼ˆã‚«ãƒ¡ãƒ©è¨±å¯ã—ã¦ãã ã•ã„ï¼‰";

      const faceDetection = new FaceDetection({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`
      });

      faceDetection.setOptions({
        model: "short",
        minDetectionConfidence: 0.6
      });

      faceDetection.onResults((results) => {
        ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);

        const dets = results?.detections || [];
        if (dets.length === 0) {
          statusEl.textContent = "é¡”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ˜ã‚‹ã„å ´æ‰€ã§æ­£é¢ã‚’å‘ã„ã¦ã­ï¼‰";
          return;
        }

        statusEl.textContent = `é¡”æ¤œçŸ¥: ${dets.length}äºº`;

        const det = dets[0];
        const box = det.boundingBox;
        if (!box) return;

        const x = box.xCenter * canvas.clientWidth;
        const y = box.yCenter * canvas.clientHeight;

        // é¡”ã®å¹…ï¼ˆpxï¼‰
        const faceW = box.width * canvas.clientWidth;

        // â˜…é¡”å¹…ã«å¯¾ã—ã¦å¸¸ã«100%ï¼ˆ= çµµæ–‡å­—ã®å¹… = é¡”ã®å¹…ï¼‰
        const size = faceW;

        ctx.drawImage(emojiImg, x - size/2, y - size/2, size, size);
      });

      async function startCamera() {
        if (camera) camera.stop();

        camera = new Camera(video, {
          onFrame: async () => {
            await faceDetection.send({ image: video });
          },
          width: 1280,
          height: 720,
          facingMode
        });

        await camera.start();
        statusEl.textContent = "èµ·å‹•ã—ã¾ã—ãŸã€‚é¡”ã‚’æ˜ ã—ã¦ã¿ã¦ãã ã•ã„ã€‚";
      }

      switchBtn.addEventListener("click", async () => {
        facingMode = (facingMode === "user") ? "environment" : "user";
        statusEl.textContent = "ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ä¸­â€¦";
        await startCamera();
      });

      await startCamera();
    }

    main().catch((e) => {
      console.error(e);
      statusEl.textContent = "èµ·å‹•å¤±æ•—ï¼šãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰/ ã‚«ãƒ¡ãƒ©è¨±å¯ / HTTPS / Chrome ã‚’ç¢ºèªã—ã¦ãã ã•ã„";
    });
  </script>
</body>
</html>
